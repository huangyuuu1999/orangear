pipeline {
    agent {
        label "local"
    } // 只在local 节点构建，部署

    stages {
        stage('Build-image&&Push') {
            steps {
                echo 'Building..已经拉取源码，在此处执行构建'// 已经拉取源码，在此处执行构建
                withCredentials([usernamePassword(credentialsId: 'jenkins-access-harbor', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')]){
                    sh """
                        echo ${PASSWORD} | docker login -u 'gongyulei' --password-stdin 43.139.176.247/fruit_buckets

                        # delete old image if exists
                        docker stop app
                        docker rm app
                        docker rmi 43.139.176.247/fruit_buckets/orangear:latest

                        # build
                        docker build -t 43.139.176.247/fruit_buckets/orangear:latest .
                        docker push 43.139.176.247/fruit_buckets/orangear:latest
                    """
                }
            }
        }
        stage('Test') {
            steps {
                echo 'Testing.. I would add some test case later...'
            }
        }
        stage('Deploy') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'jenkins-access-harbor', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')]){
                    sh """
                        echo ${PASSWORD} | docker login -u 'gongyulei' --password-stdin 43.139.176.247/fruit_buckets
                        # delete old image if exists
                        docker rmi 43.139.176.247/fruit_buckets/orangear:latest || true

                        # pull
                        docker pull 43.139.176.247/fruit_buckets/orangear:latest
                        # deploy
                        docker run --name app -d -p80:80 43.139.176.247/fruit_buckets/orangear:latest
                    """
                }
            }
        }
    }
}